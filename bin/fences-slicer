#!/usr/bin/env node

var fs = require('fs-extra');
var path = require('path');
var async = require('async');
var geojsonSlicer = require('./../index');
var nconf = require('nconf');
var colors = require('colors');

// setup config
nconf.argv().env();

if (nconf.get('config')) {
  nconf.file({file: nconf.get('config')});
}

if (! (nconf.get('inputDir') && nconf.get('outputDir') && nconf.get('regions')) ) {
  console.error(colors.red('[Invalid usage]:'),
    'Must specify inputDir, outputDir, and regions. If using config file, use --config=<path>');
  process.exit(-1);
}

/**
 * Execute slicing process. Create output files with any polygons
 * overlapping the specified regions.
 */
(function run() {

  if (!fs.existsSync(nconf.get('inputDir'))) {
    console.error(colors.red('[Error]:'), 'Input directory does not exist');
    process.exit(1);
  }

  var inputFiles = fs.readdirSync(nconf.get('inputDir'));

  /**
   *
   * @param {string} inputFile
   * @param {function} callback
   * @returns {*}
   */
  function processFile(inputFile, callback) {

    // skip non geojson files
    if (path.extname(inputFile) !== '.geojson') {
      return callback();
    }

    var regions = [];
    nconf.get('regions').forEach(function (region) {
      regions.push({
        outputFile: getOutputFile(nconf.get('outputDir'), inputFile, region.name),
        box: region.box
      });
    });

    geojsonSlicer.extractRegion(
      getInputFile(nconf.get('inputDir'), inputFile),
      regions,
      function () {
        console.log('Extractions done for ', inputFile);
        callback();
      });
  }

  if (inputFiles.length === 0) {
    console.error(colors.red('[Error]:'), 'No geojson files found for slicing!');
    process.exit(1);
  }

  console.log('Slicing these files: ', inputFiles);

  async.forEach(inputFiles, processFile, function (code) {
    if (code) {
      process.exit(code);
    }
  });
})();

function getInputFile(dir, file) {
  return path.join(dir, file);
}

function getOutputFile(dir, file, region) {
  fs.ensureDirSync(path.join(dir, region));
  return path.join(dir, region, file);
}
